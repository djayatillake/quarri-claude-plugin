---
description: Run complete data analysis pipeline orchestrating query, insights, and charts
globs:
alwaysApply: false
---

# /quarri-analyze - Full Analysis Pipeline

Orchestrate a complete data analysis pipeline by coordinating query generation, statistical analysis, business insights, and visualization.

## When to Use

Use `/quarri-analyze` when users want comprehensive analysis:
- "Analyze our sales trends"
- "What's driving customer churn?"
- "Give me insights on revenue performance"
- "Help me understand our order patterns"

This is more powerful than `/quarri-query` as it provides statistics, visualizations, and actionable insights.

## Orchestration Flow

```
/quarri-analyze
    │
    ├── 1. /quarri-query
    │       └── Generate SQL, fetch schema, execute query
    │
    ├── 2. /quarri-insights
    │       └── Statistical analysis + business interpretation
    │
    └── 3. /quarri-chart (if visualization warranted)
            └── Chart recommendation + configuration
```

### Stage 1: Query (via /quarri-query)

Generate and execute SQL for the analysis question:
1. Fetch schema using `quarri_get_schema`
2. Search for relevant metrics using `quarri_search_metrics`
3. Generate SQL following star schema patterns
4. Execute using `quarri_execute_sql`

### Stage 2: Insights (via /quarri-insights)

Analyze the query results:
- Descriptive statistics for numeric columns
- Distribution and outlier analysis
- Correlation between variables
- Time series trends if applicable
- Business interpretation and recommendations

### Stage 3: Chart (via /quarri-chart)

If data warrants visualization:
- Apply chart decision tree
- Generate appropriate chart configuration
- Recommend alternatives if applicable

## MECE Framework for Complex Analysis

When analyzing complex business questions, structure the breakdown using the MECE principle:
- **Mutually Exclusive**: Categories don't overlap
- **Collectively Exhaustive**: All possibilities covered

### MECE Application Examples

#### Revenue Analysis
"Why is revenue changing?"
```
Revenue Drivers (MECE Breakdown)
├── Volume Drivers
│   ├── Customer count
│   ├── Order frequency per customer
│   └── Units per order
├── Price Drivers
│   ├── Unit price
│   ├── Product mix shift
│   └── Discount rates
└── External Factors
    ├── Seasonality
    ├── Market conditions
    └── Competition
```

#### Customer Churn Analysis
"What's causing churn?"
```
Churn Factors (MECE Breakdown)
├── Product Issues
│   ├── Quality problems
│   ├── Feature gaps
│   └── Performance issues
├── Service Issues
│   ├── Support quality
│   ├── Response time
│   └── Resolution rate
├── Price Issues
│   ├── Absolute cost
│   ├── Perceived value
│   └── Competitor pricing
└── External Factors
    ├── Business closure
    ├── Changed needs
    └── Market exit
```

#### Sales Performance
"Why are sales underperforming?"
```
Sales Performance (MECE Breakdown)
├── Lead Generation
│   ├── Marketing qualified leads
│   ├── Inbound inquiries
│   └── Outbound prospecting
├── Conversion Rate
│   ├── Lead to opportunity
│   ├── Opportunity to proposal
│   └── Proposal to close
└── Deal Size
    ├── Initial contract value
    ├── Upsell/cross-sell
    └── Discounting
```

### When to Apply MECE

Apply MECE structuring when:
1. Question involves "why" (root cause analysis)
2. Multiple factors could explain the outcome
3. User needs comprehensive coverage
4. Decision-making requires evaluating alternatives

For simple queries ("show revenue by region"), skip MECE and provide direct analysis.

## Workflow

```
1. Parse the analysis question
   - Identify primary metric/measure
   - Identify dimensions/breakdowns
   - Determine time scope

2. Execute /quarri-query
   - Generate appropriate SQL
   - Execute and retrieve data
   - Validate results

3. Execute /quarri-insights
   - Run statistical analysis
   - Identify patterns
   - Generate business insights

4. Determine if visualization needed
   - Data has clear visual pattern?
   - More than 3 data points?
   - User explicitly requested chart?

5. If yes, execute /quarri-chart
   - Select appropriate chart type
   - Generate configuration

6. Synthesize comprehensive report
   - Combine all findings
   - Apply MECE structure if complex question
   - Prioritize actionable recommendations
```

## Output Format

```markdown
## Analysis: [Question Summary]

### Query
```sql
[SQL generated by /quarri-query]
```
[Brief explanation of what the query retrieves]

### Data Summary
- **Rows**: [count]
- **Date range**: [range]
- **Key dimensions**: [list]

### Statistical Findings
[From /quarri-insights]
- [Key statistic 1]
- [Key statistic 2]
- [Key statistic 3]

### MECE Breakdown (if applicable)
[Structured analysis of drivers/factors]

### Business Insights

#### Key Finding
**[Most important takeaway with specific numbers]**

#### Additional Insights
1. **[Insight type]**: [Specific finding]
   - Implication: [What it means]
   - Action: [What to do]

2. **[Insight type]**: [Specific finding]
   - Implication: [What it means]
   - Action: [What to do]

### Visualization
[From /quarri-chart if applicable]
[Chart type recommendation with rationale]
[Configuration or URL]

### Recommended Next Steps
1. [Immediate action]
2. [Follow-up analysis]
3. [Deeper investigation if warranted]
```

## Example: Full Analysis

**User**: "Analyze why revenue dropped last month"

**Analysis Output**:

### Query
```sql
SELECT
    DATE_TRUNC('week', order_date) as week,
    product_category,
    COUNT(*) as order_count,
    COUNT(DISTINCT customer_id) as customers,
    SUM(revenue) as revenue,
    AVG(order_value) as avg_order_value
FROM quarri.bridge
WHERE order_date >= DATE '2024-11-01'
GROUP BY week, product_category
ORDER BY week, product_category
```

### MECE Breakdown: Revenue Decline Drivers

```
Revenue = Customers × Orders/Customer × Revenue/Order

Analysis by Driver:
├── Customer Count: -8% (from 1,245 to 1,146)
│   └── PRIMARY DRIVER: New customer acquisition dropped
├── Order Frequency: -2% (from 2.3 to 2.25 orders/customer)
│   └── Minor decline, within normal range
└── Revenue per Order: +1% (from $89 to $90)
    └── Stable, slight increase
```

### Key Finding
**Customer acquisition dropped 8%, accounting for 75% of the revenue decline. New customer count fell from 312 to 198 (-37%).**

### Recommended Actions
1. **Immediate**: Review marketing spend and campaign performance from last month
2. **This week**: Analyze acquisition channel performance (paid vs organic)
3. **Follow-up**: Compare conversion rates by channel to identify where leads are dropping

## Error Handling

- If query returns no data, suggest adjusting filters or date range
- If statistical analysis fails, report data quality issues
- If MECE breakdown unclear, ask clarifying questions
- Always provide partial results if some stages succeed

## Integration

This skill orchestrates:
- `/quarri-query` for data retrieval
- `/quarri-insights` for statistical analysis and business interpretation
- `/quarri-chart` for visualization recommendations
